# Data Vault
- [Data Vault in Medallion Architecture](#data-vault-in-medallion-architecture)
- [Data Vault Architecture](#data-vault-architecture)
- [Data Vault Components](#data-vault-components)
  - [Hub](#hub)
  - [Link](#link)
  - [Satellite](#satellite)

For a large data asset, a medallion architecture (or Multi-hop) is implemented to progressviely develop structure and quality of the data assets. <br>

## Data Vault in Medallion Architecture
In the medallion architecture, there are 3 layers; Bronze, Silver and Gold.

The `Bronze layer` of the medallion architecture stores the raw data as it is. The data comes in from many different sources such as CDC (Change Data Capture), 
flat files or APIs. 

In the `Silver layer`, the raw data is processed to provide the enterprise view of the key business entities, concepts and transactions. 
This is where 3NF or data vault comes in to implement data modelling.

Lastly, the `Gold layer` contains data that are consumption-ready for the business. The data is aggregated, denormalised and optimised for read with fewer joins.
Kimball's star schema model or Inmon's data mart fits into this layer.

Going back to the silve layer, data vault provides enhanced features over 3NF data modelling. Some of advantages include:
- 3NF data modelling requires re-modelling when the business relationship changes - ex. one-to-many relationship between customers and products changing to many-to-many requires implementation of a bridge table.<br>
However, in data vault, link tables which acts as a bridge table are always present to prevent any re-modelling due to business rule changes.
- 3NF data modelling requires separate management of history tables. And this can become cumbersome when the number of tables that require history tables increases.<br>
In data vault, historical changes are captured (similar to SCD type 2 in dimensional data models) to avoid such additional workloads.

Note that for a small or one-off data asset, this approach of data management may not be appropriate, as it adds extra complexity and workloads to the system.

## Data Vault Architecture
The medallion architecture using data vault can be represented as below.

<img src=https://user-images.githubusercontent.com/46085656/185341771-45ca2e62-793b-426c-b36d-6af47be441ae.png width=600px>

- Bronze layer - Staging Area: This layer supports the data loading process from heterogeneous data sources.
- Silver layer - Raw Data Vault / Business Data vault: The raw data vault holds the raw data that its contents have not been processed. And the business data vault contains modified data based on the business rules.
- Gold layer - Data Marts: This is an information delivery layer, where it can either be a physical model or a virtual model.

Note that there are two data vaults in the architecture; raw data vault and business data vault. By having the raw data kept separated to the modified data, one can easily 
implement business changes by adding new data sources or dimensions. The business data vault also makes the data more understandable to the business users. 

## Data Vault Components
The data vaults is mainly consisted of three core components. 

<img src=https://user-images.githubusercontent.com/46085656/185341890-c161d6e8-e0bd-411b-a5e7-4d8989fc4171.png width=600px>

### Hub
Hubs are tables containing business entity identifiers. Each row is uniquely identified by the business key (BK) which has either real business meaning or is a surrogate key
from the source system. When sourcing the hub data from multiple sources, one has to be careful not to collide business keys. It is suggested to use a meaningful business
key that is unique or use a compound key made up of more than one column. <br>
And hub can optionally have a surrogate key (sequence or hash) as a primary key (PK). A surrogate key is recommended when the business key is:
- too lengthy
- not unique enough
- meaning or source system may change over time

As of the data vault 2.0, the hash key is used over the sequence key due to the following reasons:
- sequence key can get very large and requires lookups on a row by row basis
- hash key provides parallel loading by removing referential integrity (hub, link and satellite can be loaded in parallel)
- hash key is deterministic and created using hash function on the business key

However, one should be wary of the possible hash collision depending on the hash function being used. 
The hub holds the load date time to represent the first date and time the business key was discovered. And the source of the business key is recorded.

### Link
Link tables (also defined as transaction, hierarchy or relationship) act as a linkage between two or more hubs' business keys. The link contains the primary keys of the connecting hubs as the foreign keys. And the link's 
primary key is generated by combining its foreign keys, typically with a delimiter. A surrogate key may be used if the primary key is too large. The link also contains
the first load datetime and the record source for the transaction.

### Satellite
Satellite tables hold descriptive attributes to the hub or the link. They are time-dimensional table that captures historical changes. 
Each statellite can only have one parent (hub/link) table, and can never be snowflaked. The satellite contains the primary key of the parent and the load datetime. 
The parent primary key and the load datetime are used as a composite primary key to keep a track of data over time. The source of the record is also tracked. 
And most importantly, the satellite contains descriptive elements of the hub or the link. <br>
The hash difference column may be used to speed up the Change Data Capture process. This column would contain a calculated hash on the combined descriptive elements. 
And this would be compared against the hash of the inbound data to decide whether to insert the inbound data or do nothing. <br>
Note that load end datetime is not permitted under the data vault 2.0 standards to prevent physical update of the table. 


<!-- 
- other tables
- comparison to 3NF & dimension model
  - what characteristics of 3nf and dim model does data vault holds?
  - adv & drawbacks 
-->


